const VERSION="0.9.2.1",ACTIVATE_DEBUG=!1,ROOT_SITE="/commun/lib/vendor/adrianotiger/web-esheep",DEFAULT_XML=ROOT_SITE+"/pets/esheep64/animations.xml",DEFAULT_JSON=ROOT_SITE+"/pets/pets.json",COLLISION_WITH=["div","hr"];class eSheep{constructor(e,t){this.userOptions=e||{allowPets:"none",allowPopup:"yes"},this.userOptions.allowPopup||(this.userOptions.allowPopup="yes"),this.userOptions.allowPets||(this.userOptions.allowPets="none"),this.animationFile=DEFAULT_XML,this.id=Date.now()+Math.random(),this.DOMdiv=document.createElement("div"),this.DOMdiv.setAttribute("id",this.id),this.DOMimg=document.createElement("img"),this.DOMinfo=document.createElement("div"),this.parser=new DOMParser,this.xmlDoc=null,this.prepareToDie=!1,this.isChild=null!=t,this.tilesX=1,this.tilesY=1,this.imageW=1,this.imageH=1,this.imageX=1,this.imageY=1,this.flipped=!1,this.dragging=!1,this.infobox=!1,this.animationId=0,this.animationStep=0,this.animationNode=null,this.sprite=new Image,this.HTMLelement=null,this.randS=100*Math.random(),this.screenW=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,this.screenH=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}Start(e){void 0!==e&&null!=e&&(this.animationFile=e);var t=new XMLHttpRequest,i=this;t.open("GET",this.animationFile,!0),t.addEventListener("readystatechange",function(){4==this.readyState&&(200==this.status?i._parseXML(this.responseText):console.error("XML not available:"+this.statusText+"\n"+this.responseText))}),t.send(null)}remove(){this.prepareToDie=!0,this.DOMinfo.Hide(),setTimeout(()=>{this.DOMdiv=this.DOMimg=this.DOMinfo=null,document.getElementById(this.id).outerHTML=""},500)}_parseXML(e){this.xmlDoc=this.parser.parseFromString(e,"text/xml");var t=this.xmlDoc.getElementsByTagName("image")[0];this.tilesX=t.getElementsByTagName("tilesx")[0].textContent,this.tilesY=t.getElementsByTagName("tilesy")[0].textContent,this.sprite.addEventListener("load",()=>{ACTIVATE_DEBUG&&console.log("Sprite image loaded");var e="width:"+this.sprite.width+"px;height:"+this.sprite.height+"px;position:absolute;top:0px;left:0px;max-width: none;";this.DOMimg.setAttribute("style",e),this.DOMimg.addEventListener("dragstart",e=>(e.preventDefault(),!1)),this.imageW=this.sprite.width/this.tilesX,this.imageH=this.sprite.height/this.tilesY,e="width:"+this.imageW+"px;height:"+this.imageH+"px;position:fixed;top:"+this.imageY+"px;left:"+this.imageX+"px;transform:rotatey(0deg);cursor:move;z-index:2000;overflow:hidden;image-rendering: crisp-edges;",this.DOMdiv.setAttribute("style",e),this.DOMdiv.appendChild(this.DOMimg),this.isChild?this._spawnChild():this._spawnESheep()}),this.sprite.src="data:image/png;base64,"+t.getElementsByTagName("png")[0].textContent,this.DOMimg.setAttribute("src",this.sprite.src),this.DOMdiv.addEventListener("mousemove",e=>{if(!this.dragging&&1==e.buttons&&0==e.button){this.dragging=!0,this.HTMLelement=null;for(var t=this.xmlDoc.getElementsByTagName("animations")[0].getElementsByTagName("animation"),i=0;i<t.length;i++)if("drag"==t[i].getElementsByTagName("name")[0].textContent){this.animationId=t[i].getAttribute("id"),this.animationStep=0,this.animationNode=t[i];break}}}),document.body.addEventListener("mousemove",e=>{this.dragging&&(this.imageX=parseInt(e.clientX)-this.imageW/2,this.imageY=parseInt(e.clientY)-this.imageH/2,this.DOMdiv.style.left=this.imageX+"px",this.DOMdiv.style.top=this.imageY+"px",this.DOMinfo.style.left=parseInt(this.imageX+this.imageW/2)+"px",this.DOMinfo.style.top=this.imageY+"px")}),document.body.addEventListener("resize",()=>{this.screenW=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,this.screenH=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,this.imageY+this.imageH>this.screenH&&(this.imageY=this.screenH-this.imageH,this.DOMdiv.style.top=this.imageY+"px"),this.imageX+this.imageW>this.screenW&&(this.imageX=this.screenW-this.imageW,this.DOMdiv.style.left=this.imageX+"px")}),this.DOMdiv.addEventListener("contextmenu",e=>(e.preventDefault(),!1)),this.DOMdiv.addEventListener("mouseup",e=>{this.dragging?this.dragging=!1:this.infobox?(this.DOMinfo.Hide(),this.infobox=!1):"yes"===this.userOptions.allowPopup&&(this.DOMinfo.style.left=Math.min(this.screenW-this.imageW,Math.max(this.imageW,parseInt(this.imageX+this.imageW/2)))+"px",this.DOMinfo.style.top=parseInt(this.imageY)+"px",this.DOMinfo.Show(),this.infobox=!0)}),this.DOMinfo.addEventListener("mouseup",e=>{this.DOMinfo.Hide(),this.infobox=!1});var i="width:200px;height:100px;transform:translate(-50%, -50%) scale(0.1);position:fixed;top:100px;left:10px;display:none;border-width:2px;border-radius:5px;border-style:ridge;border-color:#0000ab;text-align:center;text-shadow: 1px 1px 3px #ffff88;box-shadow: 3px 3px 10px #888888;color:black;opacity:0.9;z-index:9999;overflow:auto;transition:transform 0.3s ease;background: linear-gradient(to bottom right, rgba(128,128,255,0.7), rgba(200,200,255,0.4));";this.DOMinfo.setAttribute("style",i);var s=this.xmlDoc.getElementsByTagName("header")[0],a=document.createElement("b").appendChild(document.createTextNode(s.getElementsByTagName("title")[0].textContent)),n=document.createElement("sup"),h=document.createElement("a"),o=document.createElement("p");n.appendChild(document.createTextNode("App v."+VERSION)),n.appendChild(document.createElement("br")),n.appendChild(document.createTextNode("Pet v."+s.getElementsByTagName("version")[0].textContent)),n.setAttribute("style","float:right;text-align:right;"),h.appendChild(document.createTextNode("\uD83C\uDFE0")),h.setAttribute("href","https://github.com/Adrianotiger/web-esheep"),h.setAttribute("target","_blank"),h.setAttribute("style","float:left"),o.appendChild(document.createTextNode(s.getElementsByTagName("info")[0].textContent)),o.setAttribute("style","font-size:"+(100-parseInt(s.getElementsByTagName("info")[0].textContent.length/10))+"%;"),this.DOMinfo.appendChild(n),this.DOMinfo.appendChild(h),"none"!==this.userOptions.allowPets&&((h=document.createElement("a")).appendChild(document.createTextNode("âš™")),h.setAttribute("href","javascript:;"),h.setAttribute("style","float:left"),this.DOMinfo.appendChild(h),setTimeout(()=>{this._loadPetList(h)},100)),this.DOMinfo.appendChild(a),this.DOMinfo.appendChild(document.createElement("br")),this.DOMinfo.appendChild(document.createElement("hr")),this.DOMinfo.appendChild(o),document.body.appendChild(this.DOMinfo),document.body.appendChild(this.DOMdiv),this.DOMinfo.Show=()=>{this.DOMinfo.style.display="block",this.DOMinfo.style.transform="translate(-50%, -100%) scale(1.0)"},this.DOMinfo.Hide=()=>{this.DOMinfo.style.transform="translate(-50%, -50%) scale(0.1)",setTimeout(()=>{this.DOMinfo.style.display="none"},300)}}_setPosition(e,t,i){this.DOMdiv&&(i?(this.imageX=parseInt(e),this.imageY=parseInt(t)):(this.imageX=parseInt(this.imageX)+parseInt(e),this.imageY=parseInt(this.imageY)+parseInt(t)),this.DOMdiv.style.left=this.imageX+"px",this.DOMdiv.style.top=this.imageY+"px")}_spawnESheep(){for(var e=this.xmlDoc.getElementsByTagName("spawns")[0].getElementsByTagName("spawn"),t=0,i=0;i<e.length;i++)t+=parseInt(e[0].getAttribute("probability"));var s=Math.random()*t;for(i=0,t=0;i<e.length;i++)if((t+=parseInt(e[i].getAttribute("probability")))>=s||i==e.length-1){this._setPosition(this._parseKeyWords(e[i].getElementsByTagName("x")[0].textContent),this._parseKeyWords(e[i].getElementsByTagName("y")[0].textContent),!0),ACTIVATE_DEBUG&&console.log("Spawn: "+this.imageX+", "+this.imageY),this.animationId=e[i].getElementsByTagName("next")[0].textContent,this.animationStep=0;for(var a=this.xmlDoc.getElementsByTagName("animations")[0],n=a.getElementsByTagName("animation"),h=0;h<n.length;h++)if(n[h].getAttribute("id")==this.animationId){this.animationNode=n[h];for(var a=this.xmlDoc.getElementsByTagName("childs")[0],n=a.getElementsByTagName("child"),o=0;o<n.length;o++)if(n[o].getAttribute("animationid")==this.animationId){ACTIVATE_DEBUG&&console.log("Child from Spawn");var m=new eSheep(null,!0);m.animationId=n[o].getElementsByTagName("next")[0].textContent;var r=n[o].getElementsByTagName("x")[0].textContent,l=n[o].getElementsByTagName("y")[0].textContent;m._setPosition(this._parseKeyWords(r),this._parseKeyWords(l),!0),m.Start(this.animationFile);break}break}break}this._nextESheepStep()}_spawnChild(){for(var e=this.xmlDoc.getElementsByTagName("animations")[0].getElementsByTagName("animation"),t=0;t<e.length;t++)if(e[t].getAttribute("id")==this.animationId){this.animationNode=e[t];break}this._nextESheepStep()}_parseKeyWords(value){value=(value=(value=(value=(value=(value=(value=(value=(value=(value=value.replace(/screenW/g,this.screenW)).replace(/screenH/g,this.screenH)).replace(/areaW/g,this.screenH)).replace(/areaH/g,this.screenH)).replace(/imageW/g,this.imageW)).replace(/imageH/g,this.imageH)).replace(/random/g,100*Math.random())).replace(/randS/g,this.randS)).replace(/imageX/g,this.imageX)).replace(/imageY/g,this.imageY);var ret=0;try{ret=eval(value)}catch(err){console.error("Unable to parse this position: \n'"+value+"'\n Error message: \n"+err.message)}return ret}_getNextRandomNode(e){var t=e.getElementsByTagName("next"),i=this.xmlDoc.getElementsByTagName("animations")[0],s=i.getElementsByTagName("animation"),a=0,n=!1;if(0==t.length)return this.isChild?(ACTIVATE_DEBUG&&console.log("Remove child"),document.body.removeChild(this.DOMinfo),document.body.removeChild(this.DOMdiv),delete this):this._spawnESheep(),!1;for(var h=0;h<t.length;h++)a+=parseInt(t[h].getAttribute("probability"));var o=Math.random()*a,m=0;for(h=0,a=0;h<t.length;h++)if((a+=parseInt(t[h].getAttribute("probability")))>=o){m=h;break}for(h=0;h<s.length;h++)if(s[h].getAttribute("id")==t[m].textContent){this.animationId=s[h].getAttribute("id"),this.animationStep=0,this.animationNode=s[h],n=!0;break}if(n){var i=this.xmlDoc.getElementsByTagName("childs")[0],s=i.getElementsByTagName("child");for(h=0;h<s.length;h++)if(s[h].getAttribute("animationid")==this.animationId){ACTIVATE_DEBUG&&console.log("Child from Animation");var r=new eSheep(null,!0);r.animationId=s[h].getElementsByTagName("next")[0].textContent;var l=s[h].getElementsByTagName("x")[0].textContent,g=s[h].getElementsByTagName("y")[0].textContent;r._setPosition(this._parseKeyWords(l),this._parseKeyWords(g),!0),r.Start(this.animationFile);break}}return n}_checkOverlapping(){var e,t=this.imageX,i=this.imageY+this.imageH,s=20;for(var a in this.HTMLelement&&(s=5),COLLISION_WITH)for(var n=document.body.getElementsByTagName(COLLISION_WITH[a]),h=0;h<n.length;h++)if(i>(e=n[h].getBoundingClientRect()).top-2&&i<e.top+s&&t>e.left&&t<e.right-this.imageW){var o=window.getComputedStyle(n[h]);if(""!=o.borderTopStyle&&"none"!=o.borderTopStyle&&"none"!=o.display)return n[h]}return!1}_getNodeValue(e,t,i){if(this.animationNode&&this.animationNode.getElementsByTagName(e)){if(!this.animationNode.getElementsByTagName(e)[0].getElementsByTagName(t)[0])return i;var s=this.animationNode.getElementsByTagName(e)[0].getElementsByTagName(t)[0].textContent;return this._parseKeyWords(s)}}_nextESheepStep(){if(!this.prepareToDie){var e,t=this._getNodeValue("start","x",0),i=this._getNodeValue("start","y",0),s=this._getNodeValue("start","offsety",0),a=this._getNodeValue("start","opacity",1),n=this._getNodeValue("start","interval",1e3),h=this._getNodeValue("end","x",0),o=this._getNodeValue("end","y",0),m=this._getNodeValue("end","offsety",0),r=this._getNodeValue("end","interval",1),l=this._getNodeValue("end","interval",1e3),g=this._parseKeyWords(this.animationNode.getElementsByTagName("sequence")[0].getAttribute("repeat")),d=this.animationNode.getElementsByTagName("sequence")[0].getAttribute("repeatfrom"),p=this.animationNode.getElementsByTagName("gravity"),$=this.animationNode.getElementsByTagName("border"),c=this.animationNode.getElementsByTagName("frame").length+(this.animationNode.getElementsByTagName("frame").length-d)*g;if(e=this.animationStep<this.animationNode.getElementsByTagName("frame").length?this.animationNode.getElementsByTagName("frame")[this.animationStep].textContent:0==d?this.animationNode.getElementsByTagName("frame")[this.animationStep%this.animationNode.getElementsByTagName("frame").length].textContent:this.animationNode.getElementsByTagName("frame")[parseInt(d)+parseInt((this.animationStep-d)%(this.animationNode.getElementsByTagName("frame").length-d))].textContent,this.DOMimg.style.left=-this.imageW*(e%this.tilesX)+"px",this.DOMimg.style.top=-this.imageH*parseInt(e/this.tilesX)+"px",this.dragging||this.infobox){this.animationStep++,setTimeout(this._nextESheepStep.bind(this),50);return}if(this.flipped&&(t=-t,h=-h),0==this.animationStep?this._setPosition(t,i,!1):this._setPosition(parseInt(t)+parseInt((h-t)*this.animationStep/c),parseInt(i)+parseInt((o-i)*this.animationStep/c),!1),this.animationStep++,!(this.animationStep>=c)||(this.animationNode.getElementsByTagName("action")[0]&&"flip"===this.animationNode.getElementsByTagName("action")[0].textContent&&("rotateY(0deg)"==this.DOMdiv.style.transform?(this.DOMdiv.style.transform="rotateY(180deg)",this.flipped=!0):(this.DOMdiv.style.transform="rotateY(0deg)",this.flipped=!1)),this._getNextRandomNode(this.animationNode.getElementsByTagName("sequence")[0]))){var y=!1;if(!($&&$[0]&&$[0].getElementsByTagName("next")&&(h<0&&this.imageX<0?(this.imageX=0,y=!0):h>0&&this.imageX>this.screenW-this.imageW?(this.imageX=this.screenW-this.imageW,this.DOMdiv.style.left=parseInt(this.imageX)+"px",y=!0):o<0&&this.imageY<0?(this.imageY=0,y=!0):o>0&&this.imageY>this.screenH-this.imageH?(this.imageY=this.screenH-this.imageH,y=!0):o>0?this._checkOverlapping()&&this.imageY>this.imageH&&(this.HTMLelement=this._checkOverlapping(),this.imageY=Math.ceil(this.HTMLelement.getBoundingClientRect().top)-this.imageH,y=!0):this.HTMLelement&&!this._checkOverlapping()&&(this.imageY+this.imageH>this.HTMLelement.getBoundingClientRect().top+3||this.imageY+this.imageH<this.HTMLelement.getBoundingClientRect().top-3?this.HTMLelement=null:this.imageX<this.HTMLelement.getBoundingClientRect().left?(this.imageX=parseInt(this.imageX+3),y=!0):(this.imageX=parseInt(this.imageX-3),y=!0),this.DOMdiv.style.left=parseInt(this.imageX)+"px"),y&&!this._getNextRandomNode($[0]))||!y&&p&&p[0]&&p[0].getElementsByTagName("next")&&this.imageY<this.screenH-this.imageH-2&&(null==this.HTMLelement?y=!0:this._checkOverlapping()||(y=!0,this.HTMLelement=null),y&&!this._getNextRandomNode(p[0])))){if(!y&&(this.imageX<-this.imageW&&h<0||this.imageX>this.screenW&&h>0||this.imageY<-this.imageH&&i<0||this.imageY>this.screenH&&o>0)){y=!0,this.isChild||this._spawnESheep();return}setTimeout(this._nextESheepStep.bind(this),parseInt(n)+parseInt((l-n)*this.animationStep/c))}}}}_loadPetList(e){fetch(DEFAULT_JSON,{credentials:"same-origin",cache:"force-cache"}).then(e=>e.json()).then(t=>{console.log(t),t.pets&&e.addEventListener("mouseup",i=>{i.preventDefault(),i.stopPropagation();var s=document.createElement("div");for(let a in s.setAttribute("style","position:absolute;left:0px;top:20px;width:183px;min-height:100px;background:linear-gradient(to bottom, #8080ff, #3030a1);color:yellow;"),e.parentNode.appendChild(s),t.pets){var n=document.createElement("b");n.setAttribute("style","cursor:pointer;display:block;"),n.appendChild(document.createTextNode(t.pets[a].folder)),n.addEventListener("click",()=>{new eSheep(this.userOptions).Start(ROOT_SITE+"/pets/"+t.pets[a].folder+"/animations.xml"),this.remove()}),s.appendChild(n)}s.addEventListener("click",t=>{e.parentNode.removeChild(s)})})})}}
//# sourceMappingURL=../dist/esheep.min.js.map
